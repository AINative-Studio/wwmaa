version: '3.8'

services:
  # Backend API (Python FastAPI)
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: wwmaa-backend
    ports:
      - "9001:8000"  # High port 9001 externally, 8000 internally
    environment:
      - PYTHON_ENV=development
      - PORT=8000
      - REDIS_URL=redis://redis:6379
      # Load from .env file
      - DATABASE_URL=${DATABASE_URL}
      - ZERODB_API_KEY=${ZERODB_API_KEY}
      - ZERODB_API_BASE_URL=${ZERODB_API_BASE_URL}
      - ZERODB_EMAIL=${ZERODB_EMAIL}
      - ZERODB_PASSWORD=${ZERODB_PASSWORD}
      - JWT_SECRET=${JWT_SECRET:-dev-secret-key-change-in-production}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-dev-secret-key-change-in-production}
      - JWT_ALGORITHM=${JWT_ALGORITHM:-HS256}
      - JWT_ACCESS_TOKEN_EXPIRE_MINUTES=${JWT_ACCESS_TOKEN_EXPIRE_MINUTES:-30}
      - JWT_REFRESH_TOKEN_EXPIRE_DAYS=${JWT_REFRESH_TOKEN_EXPIRE_DAYS:-7}
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
      - BEEHIIV_API_KEY=${BEEHIIV_API_KEY}
      - BEEHIIV_PUBLICATION_ID=${BEEHIIV_PUBLICATION_ID}
      - CLOUDFLARE_ACCOUNT_ID=${CLOUDFLARE_ACCOUNT_ID}
      - CLOUDFLARE_API_TOKEN=${CLOUDFLARE_API_TOKEN}
      - CF_STREAM_ACCOUNT_ID=${CF_STREAM_ACCOUNT_ID}
      - CF_STREAM_API_TOKEN=${CF_STREAM_API_TOKEN}
      - POSTMARK_API_KEY=${POSTMARK_API_KEY}
      - FROM_EMAIL=${FROM_EMAIL:-noreply@wwmaa.com}
      - AINATIVE_API_KEY=${AINATIVE_API_KEY}
      - AI_REGISTRY_API_KEY=${AI_REGISTRY_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    volumes:
      - ./backend:/app/backend  # Mount for hot reload in dev
      - ./logs:/var/log/wwmaa
    depends_on:
      - redis
    networks:
      - wwmaa-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Redis for caching and rate limiting
  redis:
    image: redis:7-alpine
    container_name: wwmaa-redis
    ports:
      - "6380:6379"  # High port 6380 externally
    volumes:
      - redis-data:/data
    networks:
      - wwmaa-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Frontend (Next.js) - Optional, can run separately with npm
  # Uncomment if you want to run frontend in Docker too
  # frontend:
  #   image: node:20-alpine
  #   container_name: wwmaa-frontend
  #   working_dir: /app
  #   ports:
  #     - "3001:3000"  # High port 3001 externally
  #   environment:
  #     - NODE_ENV=development
  #     - NEXT_PUBLIC_API_URL=http://localhost:8080
  #   volumes:
  #     - .:/app
  #     - /app/node_modules
  #     - /app/.next
  #   command: sh -c "npm install && npm run dev"
  #   networks:
  #     - wwmaa-network
  #   depends_on:
  #     - backend

  # Strapi CMS for blog content management
  strapi:
    image: node:20-alpine
    container_name: wwmaa-strapi
    working_dir: /app
    ports:
      - "1337:1337"
    environment:
      - NODE_ENV=production
      - DATABASE_CLIENT=postgres
      - DATABASE_HOST=strapi-db
      - DATABASE_PORT=5432
      - DATABASE_NAME=strapi
      - DATABASE_USERNAME=strapi
      - DATABASE_PASSWORD=${STRAPI_DATABASE_PASSWORD:-strapi_secure_password}
      - DATABASE_SSL=false
      - HOST=0.0.0.0
      - PORT=1337
      - PUBLIC_URL=${STRAPI_PUBLIC_URL:-http://localhost:1337}
      - APP_KEYS=${STRAPI_APP_KEYS:-key1,key2,key3,key4}
      - API_TOKEN_SALT=${STRAPI_API_TOKEN_SALT:-api_token_salt_change_me}
      - ADMIN_JWT_SECRET=${STRAPI_ADMIN_JWT_SECRET:-admin_jwt_secret_change_me}
      - TRANSFER_TOKEN_SALT=${STRAPI_TRANSFER_TOKEN_SALT:-transfer_token_salt_change_me}
      - JWT_SECRET=${STRAPI_JWT_SECRET:-jwt_secret_change_me}
    volumes:
      - ./cms:/app
      - strapi-uploads:/app/public/uploads
      - /app/node_modules
      - /app/.cache
      - /app/build
    command: sh -c "npm install && npm run build && npm run start"
    networks:
      - wwmaa-network
    depends_on:
      - strapi-db
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:1337/_health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # PostgreSQL database for Strapi
  strapi-db:
    image: postgres:16-alpine
    container_name: wwmaa-strapi-db
    ports:
      - "5433:5432"  # High port 5433 externally
    environment:
      - POSTGRES_DB=strapi
      - POSTGRES_USER=strapi
      - POSTGRES_PASSWORD=${STRAPI_DATABASE_PASSWORD:-strapi_secure_password}
    volumes:
      - strapi-db-data:/var/lib/postgresql/data
    networks:
      - wwmaa-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U strapi -d strapi"]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  wwmaa-network:
    driver: bridge

volumes:
  redis-data:
  strapi-db-data:
  strapi-uploads:
